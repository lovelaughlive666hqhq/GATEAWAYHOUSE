<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge">
  <meta name="robots" content="noindex, nofollow" />
  <title>QR Certificate Verification</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@3.4.1/dist/css/bootstrap.min.css">
  <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,700" rel="stylesheet">

  <style>
    html, body { background:#fff; font-family: Roboto, Arial, sans-serif; }
    #logo{ display:block; margin:40px auto 20px; max-width:230px; width:100%; height:auto; }
    #headerImg{ display:block; margin:0 auto 15px; max-width:420px; width:100%; height:auto; }
    .login-logo{ text-align:center; font-size:30px; font-weight:300; margin-bottom:15px; }
    .login-box-body{ background:#fff; padding:18px 15px; }
    h6{ font-size:14px; font-weight:300; }
    .small{ font-size:12px; color:#666; word-break:break-all; text-align:center; margin-top:10px; }
    @media (max-width: 767px){
      .container{ padding-left:12px; padding-right:12px; }
      .alert{ margin:10px 0 0 !important; }
    }
  </style>
</head>

<body class="hold-transition login-page">
  <div class="container">

    <div class='alert alert-danger' role='alert' style='text-transform: uppercase; text-align: center; margin: 10px 25px 0;'>
      This version of the ark is no longer active.
      Please visit <a href='https://ark.gatehouseawards.org/admin/login'>The new Ark here</a>
    </div>

    <div class="col-sm-6 col-sm-offset-3" style="margin-top: 40px;">
      <img src="../logo.png" id="logo" alt="GA_LOGO" onerror="this.style.display='none'">
      <img src="../QR%20Certificate%20Verification%20image.png" id="headerImg" alt="QR Certificate Verification" onerror="this.style.display='none'">

      <div class="login-logo">
        QR Certificate <b>Verification</b>
      </div>
    </div>

    <div class="col-sm-6 col-sm-offset-3" style="margin-top: 10px;">
      <div id="greenBox" class="login-box-body"
           style="margin-bottom: 20px; text-align: center; border-color: rgb(0, 166, 90); border-width: 1px; border-style: dashed;">

        <h4 id="title" style="margin-top:0;margin-bottom:15px;color:rgb(0,166,90);">Checkingâ€¦</h4>

        <div id="found" style="display:none;">
          <h6><strong>Recipient:</strong> <span id="v_name"></span></h6>
          <h6><strong>Qualification Achieved:</strong></h6>
          <h6 id="v_qualification"></h6>
          <h6 style="margin-bottom:3px;"><strong>Award Date:</strong> <span id="v_date"></span></h6>
        </div>

        <div id="notfound" style="display:none;">
          <h6>Certificate not found for this link.</h6>
        </div>

        <div class="small" id="certIdLine"></div>
      </div>
    </div>

    <div class="col-sm-6 col-sm-offset-3" style="margin-top: 0px;">
      <div class="login-box-body"
           style="margin-bottom: 20px; text-align: center; border-color: rgb(231, 51, 51); border-width: 1px; border-style: dashed;">
        <h6 style="margin-top: 0px;">
          If the details show here don't match with the certificate in front of you please contact us immediately on
        </h6>
        <h6 style="margin-bottom: 3px;">
          <strong>+44 (0)1924 609250</strong> or <strong>info@gatehouseawards.org</strong>
        </h6>
      </div>
    </div>
  </div>

<script>
  const API_URL = "https://script.google.com/macros/s/AKfycbzvvu8IxsT2LkHas6g74GHj7Jl7WjXWUDhaQkwPqkrPl2br4BqsMrkH9Os0yj-4ltx0sw/exec";
  const id = new URLSearchParams(location.search).get("id");

  const title = document.getElementById("title");
  const found = document.getElementById("found");
  const notfound = document.getElementById("notfound");
  const certIdLine = document.getElementById("certIdLine");
  const greenBox = document.getElementById("greenBox");

  function setNotFound(msg){
    title.textContent = msg;
    title.style.color = "rgb(231,51,51)";
    greenBox.style.borderColor = "rgb(231,51,51)";
    found.style.display = "none";
    notfound.style.display = "block";
  }

  function esc(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
    }[m]));
  }

  async function run(){
    if(!id){ setNotFound("Certificate Not Found"); return; }

    certIdLine.textContent = "Certificate ID: " + id;

    try{
      const res = await fetch(`${API_URL}?id=${encodeURIComponent(id)}`);
      const data = await res.json();

      if(!data || data.found === false){
        setNotFound("Certificate Not Found");
        return;
      }

      // expects keys: name, qualification, awardedDate
      document.getElementById("v_name").innerHTML = esc(data.name);
      document.getElementById("v_qualification").innerHTML = esc(data.qualification);
      document.getElementById("v_date").innerHTML = esc(data.awardedDate);

      title.textContent = "Certificate Found";
      title.style.color = "rgb(0,166,90)";
      greenBox.style.borderColor = "rgb(0,166,90)";
      found.style.display = "block";
      notfound.style.display = "none";
    }catch(e){
      setNotFound("Error Loading Certificate");
    }
  }
  run();
</script>
</body>
</html>
